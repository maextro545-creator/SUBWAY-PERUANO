<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Subway Final Fixed</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Arial Black', sans-serif; touch-action: none; user-select: none; }

        /* PANTALLAS */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; text-align: center; color: white; }
        
        #loader { background: linear-gradient(#2980b9, #6dd5fa, #ffffff); z-index: 100; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.5); border-top: 5px solid #0047AB; border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* HUD MEJORADO (FONDO BLANCO - LETRAS AZULES) */
        #hud { position: absolute; top: 20px; left: 0; width: 100%; display: none; justify-content: space-between; padding: 0 20px; box-sizing: border-box; pointer-events: none; z-index: 10; }
        
        .hud-item { 
            background: #ffffff; 
            color: #0047AB; 
            border: 3px solid #0047AB;
            border-radius: 15px; 
            padding: 8px 20px; 
            font-size: 22px; 
            display: flex; align-items: center; gap: 10px; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        
        /* BARRA PODER */
        #power-bar { position: absolute; left: 20px; top: 80px; width: 200px; height: 15px; background: #333; border: 2px solid white; display: none; border-radius: 10px; }
        #power-fill { width: 100%; height: 100%; background: #ff4500; transition: width 0.1s linear; }

        /* MEN√öS */
        #menu-start, #menu-revive, #menu-gameover { background: rgba(0,0,0,0.85); display: none; }
        button { padding: 15px 40px; font-size: 22px; border-radius: 50px; border: none; margin: 10px; cursor: pointer; font-weight: bold; text-transform: uppercase; box-shadow: 0 5px 0 rgba(0,0,0,0.5); transition: transform 0.1s; }
        button:active { transform: translateY(4px); box-shadow: none; }
        .btn-green { background: #00c853; color: white; }
        .btn-red { background: #d50000; color: white; }
    </style>
</head>
<body>

    <!-- CARGA -->
    <div id="loader" class="screen">
        <h1 style="color:#0047AB;">CARGANDO...</h1>
        <div class="spinner"></div>
    </div>

    <!-- HUD -->
    <div id="hud">
        <div class="hud-item">üèÉ <span id="score">0</span></div>
        <div class="hud-item">üí∞ <span id="coins">0</span></div>
    </div>
    <div id="power-bar"><div id="power-fill"></div></div>

    <!-- MEN√öS -->
    <div id="menu-start" class="screen">
        <h1 style="color:#ffcc00; font-size:50px; -webkit-text-stroke: 2px #0047AB;">SUBWAY<br>RUNNER</h1>
        <button class="btn-green" onclick="startGame()">‚ñ∂ JUGAR</button>
    </div>

    <div id="menu-revive" class="screen">
        <h1 style="color: white;">¬°TE ATRAPARON!</h1>
        <div style="font-size: 80px;">üëÆ‚Äç‚ôÇÔ∏è</div>
        <button class="btn-green" onclick="revive()">VIDA EXTRA</button>
        <button class="btn-red" onclick="gameOver()">RENDIRSE</button>
    </div>

    <div id="menu-gameover" class="screen">
        <h1 style="color:#ffcc00;">GAME OVER</h1>
        <p id="final-text" style="font-size: 24px;"></p>
        <button class="btn-green" onclick="resetGame()">REINTENTAR</button>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.128.0/build/three.module.js';

        const loader = document.getElementById('loader');
        const menuStart = document.getElementById('menu-start');
        const powerBar = document.getElementById('power-bar');
        const powerFill = document.getElementById('power-fill');

        let scene, camera, renderer;
        let player, policia, floorTex;
        
        let playing = false, paused = false;
        let clock = 0;
        let lanes = [-3, 0, 3];
        let currentLane = 1;
        
        // --- CONTROL DE VELOCIDAD ---
        const START_SPEED = 18; // Velocidad inicial c√≥moda
        const MAX_SPEED = 45;   // Velocidad m√°xima
        let speed = START_SPEED;
        
        let score = 0, coins = 0, lives = 1;

        // F√≠sicas
        let jumping = false, velY = 0;
        const gravity = -0.04, jumpForce = 0.85;

        // Entidades
        let obstacles = [];
        let items = [];
        let scenery = []; 
        let particles = [];

        // Poderes
        let activePower = null;
        let powerTimer = 0;
        let policeChaseTimer = 0;

        // --- INICIO ---
        setTimeout(() => {
            init3D();
            loader.style.display = 'none';
            menuStart.style.display = 'flex';
        }, 1000);

        function createFloorTexture() {
            const c = document.createElement('canvas'); c.width=256; c.height=256;
            const ctx = c.getContext('2d');
            ctx.fillStyle='#444'; ctx.fillRect(0,0,256,256);
            ctx.fillStyle='#3e2723'; for(let y=0; y<256; y+=32) ctx.fillRect(0, y, 256, 12); 
            ctx.fillStyle='#aaa'; [40, 128, 216].forEach(x => { ctx.fillRect(x-4,0,8,256); ctx.fillRect(x+4,0,8,256); });
            const t = new THREE.CanvasTexture(c); t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(3, 20); return t;
        }

        function init3D() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x87CEFA, 20, 130);
            scene.background = new THREE.Color(0x87CEFA);

            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 200);
            camera.position.set(0, 7, 12); camera.rotation.x = -0.4;

            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Luces
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 0.9); sun.position.set(30, 50, 20); sun.castShadow = true; scene.add(sun);

            // Suelo
            floorTex = createFloorTexture();
            const fl = new THREE.Mesh(new THREE.PlaneGeometry(30, 800), new THREE.MeshPhongMaterial({map:floorTex}));
            fl.rotation.x = -Math.PI/2; fl.position.z = -300; fl.receiveShadow=true; scene.add(fl);

            // Paredes
            const wMat = new THREE.MeshLambertMaterial({color: 0x555});
            const w1 = new THREE.Mesh(new THREE.BoxGeometry(10, 40, 800), wMat); w1.position.set(-20, 20, -300); scene.add(w1);
            const w2 = new THREE.Mesh(new THREE.BoxGeometry(10, 40, 800), wMat); w2.position.set(20, 20, -300); scene.add(w2);

            // Personaje (Camisa Blanca 0xFFFFFF, Jean Azul 0x1565C0)
            player = createCharacter(0xffffff, 0x1565C0); 
            scene.add(player);
            
            policia = createCharacter(0x111144, 0x111111); policia.visible = false; scene.add(policia);
        }

        function createCharacter(topColor, botColor) {
            const g = new THREE.Group();
            // Cuerpo
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8,0.9,0.5), new THREE.MeshLambertMaterial({color:topColor}));
            body.position.y=1.2; body.castShadow=true; g.add(body);
            
            // Jetpack
            const jpGroup = new THREE.Group();
            const jpMat = new THREE.MeshStandardMaterial({color:0xC0C0C0, metalness:0.8, roughness:0.2});
            const t1 = new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,0.8), jpMat); t1.rotation.z=Math.PI/2; t1.position.set(-0.2,0,0);
            const t2 = t1.clone(); t2.position.set(0.2,0,0);
            jpGroup.add(t1); jpGroup.add(t2);
            const center = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.2), new THREE.MeshLambertMaterial({color:0x333}));
            center.position.set(0,0,0.1); jpGroup.add(center);
            jpGroup.position.set(0,1.3,0.4); 
            jpGroup.visible=false; 
            g.add(jpGroup); g.jetpack=jpGroup;

            // Cabeza
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.6,0.6), new THREE.MeshLambertMaterial({color:0xffccaa}));
            head.position.y=2; g.add(head);
            const cap = new THREE.Mesh(new THREE.BoxGeometry(0.62,0.2,0.7), new THREE.MeshLambertMaterial({color:0x333333}));
            cap.position.set(0,2.3,0.1); g.add(cap);
            
            // Extremidades
            const lg = new THREE.BoxGeometry(0.25,0.8,0.25); const sk = new THREE.MeshLambertMaterial({color:0xffccaa}); const pt = new THREE.MeshLambertMaterial({color:botColor});
            const la=new THREE.Mesh(lg,sk); la.position.set(-0.55,1.5,0); g.add(la);
            const ra=new THREE.Mesh(lg,sk); ra.position.set(0.55,1.5,0); g.add(ra);
            const ll=new THREE.Mesh(lg,pt); ll.position.set(-0.25,0.6,0); g.add(ll);
            const rl=new THREE.Mesh(lg,pt); rl.position.set(0.25,0.6,0); g.add(rl);
            g.parts={la,ra,ll,rl}; return g;
        }

        function createTrain() {
            const t = new THREE.Group();
            const b = new THREE.Mesh(new THREE.BoxGeometry(2.7,3.5,45), new THREE.MeshPhongMaterial({color:0x1565C0})); b.position.y=2; b.castShadow=true; t.add(b);
            const f = new THREE.Mesh(new THREE.PlaneGeometry(2.2,1.5), new THREE.MeshBasicMaterial({color:0xFFD54F})); f.position.set(0,2.3,22.55); t.add(f);
            const r = new THREE.Mesh(new THREE.BoxGeometry(2.8,0.6,45.1), new THREE.MeshLambertMaterial({color:0xB71C1C})); r.position.y=0.6; t.add(r);
            return t;
        }

        function createTree() {
            const t = new THREE.Group();
            const tr = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.4,1.5), new THREE.MeshLambertMaterial({color:0x5D4037})); tr.position.y=0.75; t.add(tr);
            const l = new THREE.Mesh(new THREE.ConeGeometry(1.5,4,8), new THREE.MeshLambertMaterial({color:0x2E7D32})); l.position.y=2.5; t.add(l);
            return t;
        }

        function createLamp() {
            const l = new THREE.Group();
            const p = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,6), new THREE.MeshLambertMaterial({color:0x777})); p.position.y=3; l.add(p);
            const b = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.1,0.3), new THREE.MeshBasicMaterial({color:0xffff00})); b.position.set(0.4,5.9,0); l.add(b);
            return l;
        }

        // --- GAMEPLAY ---
        window.startGame = function() {
            menuStart.style.display='none';
            document.getElementById('hud').style.display='flex';
            resetLogic(); playing=true; animate();
        }

        function resetLogic() {
            // Reinicio completo
            [obstacles, items, particles, scenery].forEach(arr => {
                arr.forEach(o => scene.remove(o));
                arr.length = 0;
            });
            player.position.set(0,0,0); player.jetpack.visible=false; player.rotation.set(0,0,0);
            
            // --- FIX DE VELOCIDAD AQU√ç ---
            speed = START_SPEED; // Forzamos velocidad inicial
            
            score=0; coins=0; lives=1; activePower=null;
            paused=false; policia.visible=false; policeChaseTimer=0;
            currentLane=1; jumping=false; velY=0;
        }

        function spawnEntities() {
            if(Math.random()<0.02) {
                const t = createTrain(); const l = Math.floor(Math.random()*3);
                t.position.set(lanes[l], 0, -250); t.userData={type:'train', topY:3.8};
                scene.add(t); obstacles.push(t);
            }
            if(Math.random()<0.06) {
                const l = Math.floor(Math.random()*3);
                const tr = obstacles.find(o=>Math.abs(o.position.z-(-250))<30 && Math.abs(o.position.x-lanes[l])<1);
                const y = tr ? 5.5 : 1;
                
                const r = Math.random();
                if(r < 0.05) spawnPowerup(lanes[l], y, -250, 'jetpack');
                else if(r < 0.1) spawnPowerup(lanes[l], y, -250, 'magnet');
                else spawnCoin(lanes[l], y, -250);
            }
            if(Math.random()<0.1) {
                const side = Math.random()>0.5 ? 1 : -1;
                const x = side * (Math.random()*5 + 8);
                const obj = Math.random()>0.5 ? createTree() : createLamp();
                obj.position.set(x, 0, -250);
                scene.add(obj); scenery.push(obj);
            }
        }

        function spawnPowerup(x, y, z, type) {
            const geo = type==='jetpack' ? new THREE.BoxGeometry(1,1.5,0.5) : new THREE.TorusGeometry(0.5,0.1,8,16);
            const col = type==='jetpack' ? 0xcccccc : 0xff0000;
            const m = new THREE.Mesh(geo, new THREE.MeshLambertMaterial({color:col}));
            m.position.set(x,y,z); m.userData={type:type};
            scene.add(m); items.push(m);
        }

        function spawnCoin(x, y, z) {
            const c = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,0.1,16), new THREE.MeshPhongMaterial({color:0xffd700}));
            c.rotation.x=Math.PI/2; c.position.set(x,y,z); c.userData={type:'coin'};
            scene.add(c); items.push(c);
        }

        function spawnJetpackParticles() {
            const color = Math.random()>0.5 ? 0xffaa00 : 0xff3300;
            const p = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.3), new THREE.MeshBasicMaterial({color:color}));
            const offset = Math.random()>0.5 ? 0.2 : -0.2;
            p.position.set(player.position.x + offset, player.position.y-0.5, player.position.z+0.5);
            scene.add(p); particles.push(p);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!playing) return;
            if(paused) return;

            clock+=0.2; floorTex.offset.y -= speed*0.0005;
            spawnEntities();

            if(policeChaseTimer > 0) {
                policia.visible = true;
                policia.position.x = player.position.x; 
                policia.position.z = player.position.z + 3;
                const pa = Math.sin(clock * 1.2);
                policia.parts.ll.rotation.x=pa; policia.parts.rl.rotation.x=-pa;
                policia.parts.la.rotation.x=-pa; policia.parts.ra.rotation.x=pa;
                policeChaseTimer--;
                if(policeChaseTimer <= 0) policia.visible = false;
            }

            if(activePower) {
                powerTimer--;
                powerFill.style.width = (powerTimer/400 * 100) + '%';
                if(powerTimer<=0) { activePower=null; powerBar.style.display='none'; player.jetpack.visible=false; }
                if(activePower==='magnet') {
                    items.forEach(i=>{
                        if(i.userData.type==='coin' && i.position.distanceTo(player.position)<15) i.position.lerp(player.position, 0.2);
                    });
                }
            }

            player.position.x += (lanes[currentLane]-player.position.x)*0.2;

            if(activePower === 'jetpack') {
                // VUELO AJUSTADO (Justo encima trenes)
                player.position.y += (7.0 - player.position.y)*0.1; 
                player.rotation.x = 0.8;
                player.parts.ll.rotation.x = 0.2; player.parts.rl.rotation.x = 0.2;
                spawnJetpackParticles();
            } else {
                player.rotation.x = 0;
                let gY = 0;
                for(let o of obstacles) {
                    if(Math.abs(o.position.x-player.position.x)<1 && Math.abs(o.position.z-player.position.z)<22) {
                        if(player.position.y > 2.5) gY = 3.8; else crash();
                    }
                }
                if(player.position.y > gY || velY > 0) { player.position.y+=velY; velY+=gravity; jumping=true; }
                else { player.position.y=gY; velY=0; jumping=false; }
                
                const a = jumping ? 0 : Math.sin(clock);
                player.parts.ll.rotation.x=a; player.parts.rl.rotation.x=-a;
                player.parts.la.rotation.x=-a; player.parts.ra.rotation.x=a;
            }

            moveObj(obstacles, 35);
            moveObj(scenery, 35);
            
            for(let i=items.length-1; i>=0; i--) {
                let o = items[i]; o.position.z += speed*0.03; o.rotation.y += 0.1;
                if(o.position.distanceTo(player.position) < 2.5) {
                    if(o.userData.type === 'coin') { coins++; document.getElementById('coins').innerText=coins; }
                    else {
                        activePower = o.userData.type; powerTimer=400; powerBar.style.display='block';
                        if(activePower==='jetpack') { player.jetpack.visible=true; velY=0; }
                    }
                    scene.remove(o); items.splice(i,1);
                } else if(o.position.z > 25) { scene.remove(o); items.splice(i,1); }
            }
            
            for(let i=particles.length-1; i>=0; i--) {
                particles[i].position.z += speed*0.02; 
                particles[i].position.y += Math.random()*0.1;
                particles[i].scale.multiplyScalar(0.9);
                if(particles[i].scale.x < 0.05) { scene.remove(particles[i]); particles.splice(i,1); }
            }

            // --- AUMENTO GRADUAL Y SUAVE DE VELOCIDAD ---
            if(speed < MAX_SPEED) speed += 0.005; // Acelera muy lento
            
            score++; document.getElementById('score').innerText=Math.floor(score/10);
            renderer.render(scene, camera);
        }

        function moveObj(arr, lim) {
            for(let i=arr.length-1; i>=0; i--) {
                arr[i].position.z += speed*0.03;
                if(arr[i].position.z > lim) { scene.remove(arr[i]); arr.splice(i,1); }
            }
        }

        function crash() {
            if(paused || activePower==='jetpack') return; 
            paused=true; 
            policia.visible=true; policia.position.set(player.position.x, 0, player.position.z-2);
            policia.parts.ll.rotation.x=0; policia.parts.rl.rotation.x=0;
            
            setTimeout(()=>{ 
                if(lives>0) document.getElementById('menu-revive').style.display='flex'; 
                else gameOver();
            }, 500);
        }

        window.revive = function() {
            lives--; document.getElementById('menu-revive').style.display='none';
            player.position.y=12; velY=0; 
            obstacles.forEach(o => { if(o.position.z > -60) o.position.y = -500; });
            
            // REDUCIR UN POCO LA VELOCIDAD PARA QUE NO SEA INJUSTO AL REVIVIR
            speed = Math.max(START_SPEED, speed * 0.85);

            policeChaseTimer = 300; 
            paused=false;
        }

        window.gameOver = function() {
            document.getElementById('menu-revive').style.display='none';
            document.getElementById('final-text').innerText = `Puntos: ${Math.floor(score/10)} | Monedas: ${coins}`;
            document.getElementById('menu-gameover').style.display='flex';
        }

        window.resetGame = function() {
            document.getElementById('menu-gameover').style.display='none';
            resetLogic(); playing=true; animate();
        }

        function move(d) {
            if(paused) return;
            if(d==='l'&&currentLane>0) currentLane--;
            if(d==='r'&&currentLane<2) currentLane++;
            if(d==='u'&&!jumping) velY = jumpForce;
        }
        document.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft')move('l'); if(e.key==='ArrowRight')move('r'); if(e.key===' '||e.key==='ArrowUp')move('u'); });
        let sx,sy;
        document.addEventListener('touchstart',e=>{sx=e.changedTouches[0].screenX;sy=e.changedTouches[0].screenY;},{passive:false});
        document.addEventListener('touchend',e=>{
            let dx=e.changedTouches[0].screenX-sx; let dy=e.changedTouches[0].screenY-sy;
            if(Math.abs(dx)>Math.abs(dy)) { if(Math.abs(dx)>30) move(dx>0?'r':'l'); } else { if(dy<-30) move('u'); }
        },{passive:false});
        window.addEventListener('resize', ()=>{ if(camera&&renderer){ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);}});
    </script>
</body>
</html>